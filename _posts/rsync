---
layout: post
title: 1212(二)
date: 2017-09-05
tags: 分布式
---

rsync：一款开源备份工具；实现不同主机间镜像同步整个目录树；支持增量备份、权限、压缩等

rsync角色
1)发起端：负责发起rsync同步，操作客户机(相当于C端)

2)备份源：负责响应rsync的请求的服务器(相当于S端)

同步的方向
1)上行同步(上传)：备份源提供文档的目标位置(date在发起端)，发起端使用用户必须对目录有写入权限

2)下行同步(下载)：备份源负责提供文档原始位置(date在备份源)，发起端使用用户只需对data有读取权限即可

搭建rsync备份源
1)vim /etc/rsyncd.db

  hehe:123		//用户名:密码


2)vim /etc/rsyncd.conf

uid = nobody			//运行用户

gid = nobody			//运行组

use chroot = yes		//用户禁锢到访问目录

address = 192.168.1.10		//监听IP

port 873			//监听端口

log file = /var/log/rsyncd.log	//日志文件位置

pid file = /var/run/rsyncd.pid	//PID运行文件位置

hosts allow = 192.168.1.0/24	//允许同步的网段

[data]				//同步名

    path = /data		//同步的目录

    comment = Document Root	//描述

    read only = no

    write = yes			//用户可写

    dont compress = *.gz *.bz2 *.tgz *.zip *.rar *.z	//同步时不需压缩的格式

    auth users = hehe		//认证用户

    secrets file = /etc/rsyncd.db			//用户帐号文件位置


3)chmod 600 /etc/rsyncd.db

4)mkdir /data && chmod 777 /data

5)rsync --daemon		//独立模式运行rsync服务；停止rsync(killall rsync && rm -rf /var/run/rsyncd.pid)
rsync备份(注意将write = yes增加)
mkdir /a


1)rsync -avzH --delete rsync://hehe@192.168.1.10/data/ /a/		//将备份源中的数据下载同步到当前位置

  rsync -avzH --delete hehe@192.168.1.10::data /a/


2)rsync -avzH --delete /a/ rsync://hehe@192.168.1.10/data			//将发起端的数据上传同步到备份源；用户在备份源必须有写入权限

  rsync -avzH --delete /a/ hehe@192.168.1.10::data


详解：

-a：提供归档和属性信息

-v：显示详细信息

-z：压缩

-H：保持硬链接

-u：可实现增量备份
rsync+inofity：注意用于上行实时同步
1）安装inotify-tools

tar  zxvf  inotify-tools-*.tar.gz  -C  /usr/src/

cd  /usr/src/inotify-tools-*/

./configure

make && make install


2)inotify的使用

vi  /etc/sysctl.conf

  fs.inotify.max_queued_events = 16384 	 ##监控事件队列数

  fs.inotify.max_user_instances = 1024   ##监控实例数

  fs.inotify.max_user_watches = 1048576  ##监控的文件数量


sysctl  -p

vi  rsync_inotify.sh   ##实时同步脚本

  #!/bin/bash

  RSYNC="rsync -avzHu --delete /a/ rsync://hehe@192.168.1.10/data"

  INT_CMD="inotifywait -mrq -e modify,create,move,delete,attrib /a"

  export RSYNC_PASSWORD=123				//可解决rsync同步时，无需输入密码

  $INT_CMD | while true;do

  $RSYNC	&>/dev/null

  done


chmod  +x  rsync_inotify.sh

sh rsync_inotify.sh &	 ##启动脚本
以上软件包下载地址
链接:https://pan.baidu.com/s/1Ytnqyqt_frW5FGHu-onDZQ 密码:9fdj

Reveal的功能相对来说更强大 , 适用于UI调试视图查找 。使用方法请看 [Reveal集成指南
](http://support.revealapp.com/kb/getting-started/reveal) 。


<br>
